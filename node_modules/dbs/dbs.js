var sqlite3 = require('sqlite3').verbose();
var dbs = {};
dbs.open = function(filename){
  var fn = filename || "':memory:'";
  var ret = {};
  ret.handle = new sqlite3.Database(fn);
  ret.query = function(sql){
    var me = this;
    return new Promise(function (resolve, reject) {
      var recordset = {};
      recordset.error = null;
      recordset.items = [];
      me.handle.each(
        sql, 
        function(err, row) {
          recordset.items.push(row);
        },
        function(){
          resolve(recordset);
        }
      );
    });
  };
  ret.run = function(sql){
    var me = this;
    return new Promise(function (resolve, reject) {
      me.handle.serialize(function() {
        me.handle.run(sql); 
        resolve();
      });
    });
  };
  ret.prepare = function(sql, args){
    var me = this;
    return new Promise(function (resolve, reject) {
      me.handle.serialize(function() {
        var stmt = me.handle.prepare(sql);
        stmt.run(args);
        stmt.finalize();
        resolve();
      });
    }); 
  };
  
  ret.close = function(){
    this.handle.close();
  }
  return ret;
}
module.exports = dbs;

